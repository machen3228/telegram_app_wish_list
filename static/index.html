<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gift Wishlist</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #0088cc;
            --tg-theme-button-color: #0088cc;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f5f5f5;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding-bottom: 80px;
        }

        /* –¢–∞–±—ã –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        .tabs {
            display: flex;
            background: var(--tg-theme-secondary-bg-color);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 2px solid var(--tg-theme-hint-color);
        }

        .tab {
            flex: 1;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
            border: none;
            background: transparent;
            color: var(--tg-theme-text-color);
        }

        .tab:hover {
            background: rgba(0, 136, 204, 0.1);
        }

        .tab.active {
            color: var(--tg-theme-button-color);
            border-bottom: 3px solid var(--tg-theme-button-color);
            margin-bottom: -2px;
        }

        .tab-content {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* –°—Ç–∞—Ç—É—Å—ã –∑–∞–≥—Ä—É–∑–∫–∏ */
        .status {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }

        .status.loading {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
        }

        /* –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 16px;
            margin-bottom: 24px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--tg-theme-button-color);
            flex-shrink: 0;
        }

        .profile-info {
            flex: 1;
            min-width: 0;
        }

        .profile-name {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .profile-username {
            font-size: 14px;
            color: var(--tg-theme-hint-color);
            margin-bottom: 8px;
        }

        .profile-id {
            font-size: 12px;
            color: var(--tg-theme-hint-color);
            font-family: monospace;
        }

        /* –°–µ–∫—Ü–∏–∏ */
        .section {
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--tg-theme-hint-color);
            font-size: 14px;
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.1s;
            font-size: 14px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }

        .btn-danger {
            background: #ef5350;
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–¥–∞—Ä–∫–æ–≤ */
        .gifts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .gift-card {
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 12px;
            padding: 16px;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .gift-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .gift-card.own .gift-delete-btn {
            display: block;
        }

        .gift-delete-btn {
            display: none;
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: #ef5350;
            color: white;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
        }

        .gift-delete-btn:hover {
            background: #e53935;
        }

        .gift-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
            padding-right: 40px;
        }

        .gift-name {
            font-size: 18px;
            font-weight: 600;
            flex: 1;
        }

        .gift-wish-rate {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        .gift-url {
            display: inline-block;
            color: var(--tg-theme-link-color);
            text-decoration: none;
            font-size: 14px;
            margin-bottom: 8px;
            word-break: break-all;
        }

        .gift-url:hover {
            text-decoration: underline;
        }

        .gift-price {
            color: var(--tg-theme-button-color);
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .gift-note {
            margin-top: 8px;
            padding: 8px;
            background: var(--tg-theme-bg-color);
            border-radius: 6px;
            font-size: 14px;
            color: var(--tg-theme-hint-color);
            font-style: italic;
        }

        .gift-date {
            font-size: 12px;
            color: var(--tg-theme-hint-color);
            margin-top: 8px;
        }

        /* –°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π */
        .friends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
        }

        .friend-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            position: relative;
        }

        .friend-card:hover {
            transform: translateX(4px);
            background: rgba(0, 136, 204, 0.1);
        }

        .friend-delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 50%;
            background: #ef5350;
            color: white;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .friend-card:hover .friend-delete-btn {
            opacity: 1;
        }

        .friend-delete-btn:hover {
            background: #e53935;
        }

        .friend-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--tg-theme-button-color);
            flex-shrink: 0;
        }

        .friend-info {
            flex: 1;
            min-width: 0;
        }

        .friend-name {
            font-weight: 500;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .friend-username {
            font-size: 12px;
            color: var(--tg-theme-hint-color);
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--tg-theme-bg-color);
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .modal-buttons .btn {
            flex: 1;
        }

        /* –§–æ—Ä–º—ã */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color);
            border-radius: 8px;
            font-size: 14px;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color);
        }

        textarea.form-input {
            min-height: 80px;
            resize: vertical;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .container {
                padding-bottom: 60px;
            }

            .profile-header {
                flex-direction: column;
                text-align: center;
                padding: 16px;
            }

            .profile-avatar {
                width: 100px;
                height: 100px;
            }

            .gifts-grid {
                grid-template-columns: 1fr;
            }

            .friends-grid {
                grid-template-columns: 1fr;
            }

            .section-title {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
        <div id="loading" class="container">
            <div class="status loading">
                –ó–∞–≥—Ä—É–∑–∫–∞...
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
        <div id="main-app" style="display: none;">
            <!-- –¢–∞–±—ã –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
            <div class="tabs">
                <button class="tab active" data-tab="profile">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
                <button class="tab" data-tab="friends">üë• –î—Ä—É–∑—å—è</button>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ -->
            <div class="container">
                <!-- –í–∫–ª–∞–¥–∫–∞: –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å -->
                <div id="tab-profile" class="tab-content active">
                    <div class="profile-header">
                        <img id="my-avatar" class="profile-avatar" src="" alt="Avatar">
                        <div class="profile-info">
                            <div id="my-name" class="profile-name"></div>
                            <div id="my-username" class="profile-username"></div>
                            <div id="my-id" class="profile-id"></div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">üéÅ –ú–æ–∏ –ø–æ–¥–∞—Ä–∫–∏</h2>
                            <button class="btn btn-primary btn-small" onclick="openAddGiftModal()">
                                + –î–æ–±–∞–≤–∏—Ç—å
                            </button>
                        </div>
                        <div id="my-gifts-container"></div>
                    </div>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞: –î—Ä—É–∑—å—è -->
                <div id="tab-friends" class="tab-content">
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">üë• –ú–æ–∏ –¥—Ä—É–∑—å—è</h2>
                            <button class="btn btn-primary btn-small" onclick="openAddFriendModal()">
                                + –î–æ–±–∞–≤–∏—Ç—å
                            </button>
                        </div>
                        <div id="friends-container"></div>
                    </div>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞: –ü—Ä–æ—Ñ–∏–ª—å –¥—Ä—É–≥–∞ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è) -->
                <div id="tab-friend-profile" class="tab-content">
                    <button class="btn btn-small" onclick="showTab('friends')" style="margin-bottom: 16px;">
                        ‚Üê –ù–∞–∑–∞–¥ –∫ –¥—Ä—É–∑—å—è–º
                    </button>

                    <div class="profile-header">
                        <img id="friend-avatar" class="profile-avatar" src="" alt="Avatar">
                        <div class="profile-info">
                            <div id="friend-name" class="profile-name"></div>
                            <div id="friend-username" class="profile-username"></div>
                            <div id="friend-id" class="profile-id"></div>
                        </div>
                    </div>

                    <div class="section">
                        <h2 class="section-title">üéÅ –í–∏—à–ª–∏—Å—Ç</h2>
                        <div id="friend-gifts-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫ -->
        <div id="modal-add-gift" class="modal">
            <div class="modal-content">
                <div class="modal-header">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫</div>
                <form id="form-add-gift" onsubmit="handleAddGift(event)">
                    <div class="form-group">
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                        <input type="text" name="name" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–°—Å—ã–ª–∫–∞</label>
                        <input type="url" name="url" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ñ–µ–ª–∞–µ–º–æ—Å—Ç—å (1-10)</label>
                        <input type="number" name="wish_rate" class="form-input" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–¶–µ–Ω–∞ (‚ÇΩ)</label>
                        <input type="number" name="price" class="form-input" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ó–∞–º–µ—Ç–∫–∞</label>
                        <textarea name="note" class="form-input"></textarea>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="btn" onclick="closeModal('modal-add-gift')">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                        <button type="submit" class="btn btn-primary">
                            –î–æ–±–∞–≤–∏—Ç—å
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞ -->
        <div id="modal-add-friend" class="modal">
            <div class="modal-content">
                <div class="modal-header">–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</div>
                <form id="form-add-friend" onsubmit="handleAddFriend(event)">
                    <div class="form-group">
                        <label class="form-label">Telegram ID –¥—Ä—É–≥–∞ *</label>
                        <input type="number" name="friend_id" class="form-input" required
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 123456789">
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="btn" onclick="closeModal('modal-add-friend')">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                        <button type="submit" class="btn btn-primary">
                            –î–æ–±–∞–≤–∏—Ç—å
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ============= –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ =============
        const state = {
            initData: null,
            currentUser: null,
            myGifts: [],
            myFriends: [],
            selectedFriend: null,
            selectedFriendGifts: []
        };

        // ============= –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp =============
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram
        if (tg.themeParams) {
            const root = document.documentElement;
            Object.entries(tg.themeParams).forEach(([key, value]) => {
                root.style.setProperty(`--tg-theme-${key.replace(/_/g, '-')}`, value);
            });
        }

        state.initData = tg.initData;

        // ============= API –∑–∞–ø—Ä–æ—Å—ã =============
        async function apiRequest(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'X-Telegram-Init-Data': state.initData,
                    ...options.headers
                },
                ...options
            };

            try {
                const response = await fetch(url, defaultOptions);

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.detail || `HTTP ${response.status}`);
                }

                // –î–ª—è DELETE –∑–∞–ø—Ä–æ—Å–æ–≤ –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å —Ç–µ–ª–∞ –æ—Ç–≤–µ—Ç–∞
                if (response.status === 204) {
                    return null;
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // ============= API –º–µ—Ç–æ–¥—ã =============
        async function getCurrentUser() {
            return await apiRequest('/users/me');
        }

        async function getMyFriends() {
            return await apiRequest('/users/me/friends');
        }

        async function addFriend(friendId) {
            return await apiRequest(`/users/me/friends/${friendId}`, {
                method: 'POST'
            });
        }

        async function deleteFriend(friendId) {
            return await apiRequest(`/users/me/friends/${friendId}`, {
                method: 'DELETE'
            });
        }

        async function getUserById(userId) {
            return await apiRequest(`/users/${userId}`);
        }

        async function getUserGifts(userId) {
            return await apiRequest(`/users/${userId}/gifts`);
        }

        async function addGift(giftData) {
            return await apiRequest('/gifts', {
                method: 'POST',
                body: JSON.stringify(giftData)
            });
        }

        async function deleteGift(giftId) {
            return await apiRequest(`/gifts/${giftId}`, {
                method: 'DELETE'
            });
        }

        // ============= –£—Ç–∏–ª–∏—Ç—ã =============
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('ru-RU').format(price);
        }

        function getAvatarUrl(user) {
            if (user.avatar_url) {
                return user.avatar_url;
            }
            return `https://ui-avatars.com/api/?name=${encodeURIComponent(user.first_name)}&size=200&background=0088cc&color=fff`;
        }

        // ============= –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ç–∞–±–∞–º =============
        function showTab(tabName) {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö —Ç–∞–±–æ–≤ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω—É–∂–Ω—ã–π —Ç–∞–±
            const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
            if (tabButton) {
                tabButton.classList.add('active');
            }

            const tabContent = document.getElementById(`tab-${tabName}`);
            if (tabContent) {
                tabContent.classList.add('active');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –ø–æ —Ç–∞–±–∞–º
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                showTab(tabName);
            });
        });

        // ============= –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ =============
        function renderMyProfile() {
            const user = state.currentUser;

            document.getElementById('my-avatar').src = getAvatarUrl(user);
            document.getElementById('my-name').textContent =
                `${user.first_name}${user.last_name ? ' ' + user.last_name : ''}`;
            document.getElementById('my-username').textContent =
                user.tg_username ? `@${user.tg_username}` : '';
            document.getElementById('my-id').textContent = `ID: ${user.tg_id}`;

            renderMyGifts();
        }

        function renderMyGifts() {
            const container = document.getElementById('my-gifts-container');
            const gifts = state.currentUser.gifts || [];

            if (gifts.length === 0) {
                container.innerHTML = '<div class="section-empty">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥–∞—Ä–∫–æ–≤ –≤ —Å–ø–∏—Å–∫–µ –∂–µ–ª–∞–Ω–∏–π</div>';
                return;
            }

            container.innerHTML = `
                <div class="gifts-grid">
                    ${gifts.map(gift => `
                        <div class="gift-card own">
                            <button class="gift-delete-btn" onclick="confirmDeleteGift(${gift.id})" title="–£–¥–∞–ª–∏—Ç—å">
                                √ó
                            </button>
                            <div class="gift-header">
                                <div class="gift-name">${escapeHtml(gift.name)}</div>
                                ${gift.wish_rate ? `<div class="gift-wish-rate">‚≠ê ${gift.wish_rate}/10</div>` : ''}
                            </div>
                            ${gift.url ? `<a href="${escapeHtml(gift.url)}" class="gift-url" target="_blank">üîó –°—Å—ã–ª–∫–∞</a>` : ''}
                            ${gift.price ? `<div class="gift-price">üí∞ ${formatPrice(gift.price)} ‚ÇΩ</div>` : ''}
                            ${gift.note ? `<div class="gift-note">üìù ${escapeHtml(gift.note)}</div>` : ''}
                            <div class="gift-date">–î–æ–±–∞–≤–ª–µ–Ω: ${new Date(gift.created_at).toLocaleDateString('ru-RU')}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderFriends() {
            const container = document.getElementById('friends-container');
            const friends = state.myFriends;

            if (friends.length === 0) {
                container.innerHTML = '<div class="section-empty">–ü–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π</div>';
                return;
            }

            container.innerHTML = `
                <div class="friends-grid">
                    ${friends.map(friend => `
                        <div class="friend-card" onclick="showFriendProfile(${friend.tg_id})">
                            <button class="friend-delete-btn" onclick="event.stopPropagation(); confirmDeleteFriend(${friend.tg_id})" title="–£–¥–∞–ª–∏—Ç—å">
                                √ó
                            </button>
                            <img class="friend-avatar" src="${getAvatarUrl(friend)}" alt="Avatar">
                            <div class="friend-info">
                                <div class="friend-name">${escapeHtml(friend.first_name)}${friend.last_name ? ' ' + escapeHtml(friend.last_name) : ''}</div>
                                <div class="friend-username">${friend.tg_username ? '@' + escapeHtml(friend.tg_username) : 'ID: ' + friend.tg_id}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderFriendProfile() {
            const friend = state.selectedFriend;

            document.getElementById('friend-avatar').src = getAvatarUrl(friend);
            document.getElementById('friend-name').textContent =
                `${friend.first_name}${friend.last_name ? ' ' + friend.last_name : ''}`;
            document.getElementById('friend-username').textContent =
                friend.tg_username ? `@${friend.tg_username}` : '';
            document.getElementById('friend-id').textContent = `ID: ${friend.tg_id}`;

            renderFriendGifts();
        }

        function renderFriendGifts() {
            const container = document.getElementById('friend-gifts-container');
            const gifts = state.selectedFriendGifts;

            if (gifts.length === 0) {
                container.innerHTML = '<div class="section-empty">–£ –¥—Ä—É–≥–∞ –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥–∞—Ä–∫–æ–≤ –≤ –≤–∏—à–ª–∏—Å—Ç–µ</div>';
                return;
            }

            container.innerHTML = `
                <div class="gifts-grid">
                    ${gifts.map(gift => `
                        <div class="gift-card">
                            <div class="gift-header">
                                <div class="gift-name">${escapeHtml(gift.name)}</div>
                                ${gift.wish_rate ? `<div class="gift-wish-rate">‚≠ê ${gift.wish_rate}/10</div>` : ''}
                            </div>
                            ${gift.url ? `<a href="${escapeHtml(gift.url)}" class="gift-url" target="_blank">üîó –°—Å—ã–ª–∫–∞</a>` : ''}
                            ${gift.price ? `<div class="gift-price">üí∞ ${formatPrice(gift.price)} ‚ÇΩ</div>` : ''}
                            ${gift.note ? `<div class="gift-note">üìù ${escapeHtml(gift.note)}</div>` : ''}
                            <div class="gift-date">–î–æ–±–∞–≤–ª–µ–Ω: ${new Date(gift.created_at).toLocaleDateString('ru-RU')}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ============= –î–µ–π—Å—Ç–≤–∏—è —Å –ø–æ–¥–∞—Ä–∫–∞–º–∏ =============
        function openAddGiftModal() {
            document.getElementById('modal-add-gift').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            const form = document.querySelector(`#${modalId} form`);
            if (form) form.reset();
        }

        async function handleAddGift(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const giftData = {
                user_id: state.currentUser.tg_id,
                name: formData.get('name'),
                url: formData.get('url') || null,
                wish_rate: formData.get('wish_rate') ? parseInt(formData.get('wish_rate')) : null,
                price: formData.get('price') ? parseInt(formData.get('price')) : null,
                note: formData.get('note') || null
            };

            try {
                await addGift(giftData);
                closeModal('modal-add-gift');

                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                state.currentUser = await getCurrentUser();
                renderMyGifts();

                tg.showPopup({
                    title: '–£—Å–ø–µ—Ö',
                    message: '–ü–æ–¥–∞—Ä–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≤–∏—à–ª–∏—Å—Ç!',
                    buttons: [{type: 'ok'}]
                });
            } catch (error) {
                tg.showPopup({
                    title: '–û—à–∏–±–∫–∞',
                    message: error.message,
                    buttons: [{type: 'ok'}]
                });
            }
        }

        function confirmDeleteGift(giftId) {
            tg.showPopup({
                title: '–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫?',
                message: '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫ –∏–∑ –≤–∏—à–ª–∏—Å—Ç–∞?',
                buttons: [
                    {id: 'cancel', type: 'cancel'},
                    {id: 'delete', type: 'destructive', text: '–£–¥–∞–ª–∏—Ç—å'}
                ]
            }, async (buttonId) => {
                if (buttonId === 'delete') {
                    try {
                        await deleteGift(giftId);

                        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                        state.currentUser = await getCurrentUser();
                        renderMyGifts();

                        tg.showPopup({
                            title: '–£—Å–ø–µ—Ö',
                            message: '–ü–æ–¥–∞—Ä–æ–∫ —É–¥–∞–ª—ë–Ω',
                            buttons: [{type: 'ok'}]
                        });
                    } catch (error) {
                        tg.showPopup({
                            title: '–û—à–∏–±–∫–∞',
                            message: error.message,
                            buttons: [{type: 'ok'}]
                        });
                    }
                }
            });
        }

        // ============= –î–µ–π—Å—Ç–≤–∏—è —Å –¥—Ä—É–∑—å—è–º–∏ =============
        function openAddFriendModal() {
            document.getElementById('modal-add-friend').classList.add('active');
        }

        async function handleAddFriend(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const friendId = parseInt(formData.get('friend_id'));

            if (friendId === state.currentUser.tg_id) {
                tg.showPopup({
                    title: '–û—à–∏–±–∫–∞',
                    message: '–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è –≤ –¥—Ä—É–∑—å—è',
                    buttons: [{type: 'ok'}]
                });
                return;
            }

            try {
                await addFriend(friendId);
                closeModal('modal-add-friend');

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π
                state.myFriends = await getMyFriends();
                renderFriends();

                tg.showPopup({
                    title: '–£—Å–ø–µ—Ö',
                    message: '–î—Ä—É–≥ –¥–æ–±–∞–≤–ª–µ–Ω!',
                    buttons: [{type: 'ok'}]
                });
            } catch (error) {
                tg.showPopup({
                    title: '–û—à–∏–±–∫–∞',
                    message: error.message,
                    buttons: [{type: 'ok'}]
                });
            }
        }

        function confirmDeleteFriend(friendId) {
            tg.showPopup({
                title: '–£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π?',
                message: '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –¥—Ä—É–∑–µ–π?',
                buttons: [
                    {id: 'cancel', type: 'cancel'},
                    {id: 'delete', type: 'destructive', text: '–£–¥–∞–ª–∏—Ç—å'}
                ]
            }, async (buttonId) => {
                if (buttonId === 'delete') {
                    try {
                        await deleteFriend(friendId);

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π
                        state.myFriends = await getMyFriends();
                        renderFriends();

                        tg.showPopup({
                            title: '–£—Å–ø–µ—Ö',
                            message: '–î—Ä—É–≥ —É–¥–∞–ª—ë–Ω',
                            buttons: [{type: 'ok'}]
                        });
                    } catch (error) {
                        tg.showPopup({
                            title: '–û—à–∏–±–∫–∞',
                            message: error.message,
                            buttons: [{type: 'ok'}]
                        });
                    }
                }
            });
        }

        async function showFriendProfile(friendId) {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∞ –∏ –µ–≥–æ –ø–æ–¥–∞—Ä–∫–∏
                state.selectedFriend = await getUserById(friendId);
                state.selectedFriendGifts = await getUserGifts(friendId);

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –¥—Ä—É–≥–∞
                renderFriendProfile();
                showTab('friend-profile');
            } catch (error) {
                tg.showPopup({
                    title: '–û—à–∏–±–∫–∞',
                    message: '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –¥—Ä—É–≥–∞',
                    buttons: [{type: 'ok'}]
                });
            }
        }

        // ============= –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è =============
        async function initApp() {
            try {
                if (!state.initData) {
                    throw new Error('–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑ Telegram');
                }

                // –°–Ω–∞—á–∞–ª–∞ –¥–µ–ª–∞–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ /users/auth/telegram
                // –≠—Ç–æ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç —Å–æ–∑–¥–∞—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                state.currentUser = await apiRequest('/users/auth/telegram', {
                    method: 'POST',
                    body: JSON.stringify({
                        init_data: state.initData
                    })
                });

                console.log('User authenticated:', state.currentUser);

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥—Ä—É–∑–µ–π
                state.myFriends = await getMyFriends();

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';

                // –†–µ–Ω–¥–µ—Ä–∏–º –ø—Ä–æ—Ñ–∏–ª—å –∏ –¥—Ä—É–∑–µ–π
                renderMyProfile();
                renderFriends();

                } catch (error) {
                    console.error('Init error:', error);
                    document.getElementById('loading').innerHTML = `
                        <div class="status error">
                            ‚ùå –û—à–∏–±–∫–∞: ${error.message}
                        </div>
                    `;
                }
            }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        initApp();
    </script>
</body>
</html>